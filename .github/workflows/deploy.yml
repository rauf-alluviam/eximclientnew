name: Deploy EXIM Application to EC2 + S3

on:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  S3_BUCKET: exim-client-prod
  AWS_REGION: ap-south-1
  EC2_HOST: ${{ secrets.EC2_HOST }}
  NODE_VERSION: '18'

jobs:
  # Build and test frontend
  frontend-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./client
      run: npm ci
    
    - name: Run frontend tests
      working-directory: ./client
      run: npm test -- --coverage --watchAll=false
    
    - name: Build frontend
      working-directory: ./client
      env:
        REACT_APP_API_STRING: https://exim.alvision.in/api
        REACT_APP_VERSION: ${{ github.sha }}
        REACT_APP_S3_BUCKET: exim-test-upload
        REACT_APP_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
        REACT_APP_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        REACT_APP_AWS_REGION: ap-south-1
        REACT_APP_ELOCK_URL: http://elock-tracking.s3-website.ap-south-1.amazonaws.com/
        NODE_ENV: production
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: client/build/
        retention-days: 7

  # Build backend
  backend-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
    
    - name: Install backend dependencies
      working-directory: ./server
      run: npm ci
    
    - name: Run backend tests (if available)
      working-directory: ./server
      run: npm test || echo "No tests configured"
    
    - name: Create deployment package
      run: |
        mkdir -p deployment-package
        cp -r server/* deployment-package/
        cp nginx.conf deployment-package/
        cp server/docker-compose.yml deployment-package/
        tar -czf backend-deployment.tar.gz -C deployment-package .
    
    - name: Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: backend-deployment
        path: backend-deployment.tar.gz
        retention-days: 7

  # Deploy frontend to S3
  deploy-frontend:
    needs: frontend-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: build/
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Deploy to S3
      run: |
        # Sync static assets with long cache
        aws s3 sync build/ s3://${{ env.S3_BUCKET }} \
          --delete \
          --cache-control "public, max-age=31536000" \
          --exclude "*.html" \
          --exclude "service-worker.js" \
          --exclude "manifest.json"
        
        # Sync HTML files with no cache
        aws s3 sync build/ s3://${{ env.S3_BUCKET }} \
          --cache-control "no-cache, no-store, must-revalidate" \
          --include "*.html" \
          --include "service-worker.js" \
          --include "manifest.json"
    
    - name: Invalidate CloudFront
      if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
      env:
        CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*"
    
    - name: Get S3 website URL
      run: |
        WEBSITE_URL="http://${{ env.S3_BUCKET }}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
        echo "Frontend deployed to: $WEBSITE_URL"
        echo "FRONTEND_URL=$WEBSITE_URL" >> $GITHUB_ENV

  # Deploy backend to EC2
  deploy-backend:
    needs: backend-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    
    steps:
    - name: Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: backend-deployment
        path: .
    
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to EC2
      env:
        EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
      run: |
        # Upload deployment package
        scp -i ~/.ssh/id_rsa backend-deployment.tar.gz ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:~/
        
        # Deploy on EC2
        ssh -i ~/.ssh/id_rsa ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
          # Stop existing services
          docker-compose down || true
          
          # Extract new deployment
          tar -xzf backend-deployment.tar.gz
          
          # Start new services
          docker-compose up -d --build
          
          # Wait for services to start
          sleep 30
          
          # Check health
          if curl -f http://localhost:9000/api/health; then
            echo "âœ… Backend deployment successful!"
            docker ps
          else
            echo "âŒ Backend deployment failed!"
            docker logs exim-backend
            exit 1
          fi
          
          # Clean up
          rm backend-deployment.tar.gz
        EOF

  # Run post-deployment tests
  post-deployment-tests:
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    
    steps:
    - name: Test frontend availability
      run: |
        FRONTEND_URL="http://${{ env.S3_BUCKET }}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
        curl -f $FRONTEND_URL || exit 1
        echo "âœ… Frontend is accessible"
    
    - name: Test backend API
      run: |
        API_URL="https://exim.alvision.in/api/health"
        curl -f $API_URL || exit 1
        echo "âœ… Backend API is accessible"
    
    - name: Test nginx
      run: |
        TEST_URL="https://exim.alvision.in/test"
        curl -f $TEST_URL || exit 1
        echo "âœ… Nginx is working"

  # Notify deployment status
  notify:
    needs: [deploy-frontend, deploy-backend, post-deployment-tests]
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production')
    
    steps:
    - name: Deployment notification
      run: |
        if [ "${{ needs.post-deployment-tests.result }}" == "success" ]; then
          echo "ðŸŽ‰ Deployment successful!"
          echo "Frontend: http://${{ env.S3_BUCKET }}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          echo "Backend: https://exim.alvision.in/api"
        else
          echo "âŒ Deployment failed!"
          exit 1
        fi
