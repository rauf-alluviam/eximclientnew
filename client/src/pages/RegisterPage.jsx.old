import React, { useState, useContext, useEffect } from "react";
import axios from "axios";
import {
  TextField,
  Button,
  Box,
  Typography,
  Alert,
  Autocomplete,
  Grid,
  Card,
  CardContent,
  Chip,
  CircularProgress,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  IconButton,
  InputAdornment,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Snackbar,
  Tooltip,
  Avatar,
  Breadcrumbs,
  Stack,
  Fade,
  Slide,
  LinearProgress,
  Switch,
  FormControlLabel,
  Tabs,
  Tab,
  Divider,
} from "@mui/material";
import { 
  Business, 
  ContactMail, 
  Visibility, 
  VisibilityOff, 
  Edit, 
  ManageAccounts, 
  ContentCopy,
  Dashboard,
  PeopleAlt,
  Security,
  Assessment,
  Add,
  Info,
  TrendingUp,
  Group,
  PersonAdd,
  Analytics,
  BarChart,
  Timeline,
  CheckCircle,
  Cancel,
  Pending,
  Today,
  Password,
  Assignment,
  Settings,
  Logout,
} from "@mui/icons-material";
import { useNavigate, Link } from "react-router-dom";
import { UserContext } from "../context/UserContext";
import { validateSuperAdminToken } from "../utils/tokenValidation";
import { 
  LineChart, 
  Line, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip as ChartTooltip, 
  ResponsiveContainer,
  BarChart as RechartsBarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  Legend
} from 'recharts';
import "../styles/login.scss";

function SuperAdminDashboard() {
  // Dashboard data states
  const [dashboardData, setDashboardData] = useState(null);
  const [userActivity, setUserActivity] = useState([]);
  const [moduleAssignments, setModuleAssignments] = useState([]);
  const [weeklyRegistrations, setWeeklyRegistrations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  // Tab state
  const [activeTab, setActiveTab] = useState(0);
  const [userActivityTab, setUserActivityTab] = useState(0); // 0: Active, 1: Inactive
  
  // Modal states
  const [showRegistrationModal, setShowRegistrationModal] = useState(false);
  const [showUserManagementModal, setShowUserManagementModal] = useState(false);
  
  // Original registration states (kept for the registration modal)
  const [registrationError, setRegistrationError] = useState(null);
  const [successMessage, setSuccessMessage] = useState(null);
  const [ie_code_no, setIeCodeNo] = useState("");
  const [pan_number, setPanNumber] = useState("");
  const [name, setName] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [generatedPassword, setGeneratedPassword] = useState("");
  const [kycRecords, setKycRecords] = useState([]);
  const [selectedKyc, setSelectedKyc] = useState(null);
  const [registrationMode, setRegistrationMode] = useState("dropdown");
  
  // Password management states (for user management)
  const [existingCustomers, setExistingCustomers] = useState([]);
  const [showPasswordDialog, setShowPasswordDialog] = useState(false);
  const [selectedCustomer, setSelectedCustomer] = useState(null);
  const [newPassword, setNewPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [updatingPassword, setUpdatingPassword] = useState(false);
  const [copySnackbar, setCopySnackbar] = useState({ open: false, message: "" });
  const [hidePasswords, setHidePasswords] = useState(false);
  
  // SuperAdmin authentication state
  const [isAuthenticating, setIsAuthenticating] = useState(true);
  
  const navigate = useNavigate();
  const { user, setUser } = useContext(UserContext);

  // Helper function to get SuperAdmin authorization headers
  const getSuperAdminHeaders = () => {
    const validation = validateSuperAdminToken();
    
    if (!validation.isValid) {
      navigate("/superadmin-login");
      return null;
    }
    
    return {
      headers: {
        Authorization: `Bearer ${validation.token}`,
        'Content-Type': 'application/json',
      },
      withCredentials: true,
    };
  };

  // Fetch dashboard analytics
  const fetchDashboardData = async () => {
    try {
      const headers = getSuperAdminHeaders();
      if (!headers) return;

      const [analyticsRes, userActivityRes, moduleRes, weeklyRes] = await Promise.all([
        axios.get(`${process.env.REACT_APP_API_STRING}/dashboard/analytics`, headers),
        axios.get(`${process.env.REACT_APP_API_STRING}/dashboard/user-activity?type=active&limit=5`, headers),
        axios.get(`${process.env.REACT_APP_API_STRING}/dashboard/module-assignments`, headers),
        axios.get(`${process.env.REACT_APP_API_STRING}/dashboard/weekly-registrations`, headers)
      ]);

      setDashboardData(analyticsRes.data.data);
      setUserActivity(userActivityRes.data.data.users);
      setModuleAssignments(moduleRes.data.data);
      setWeeklyRegistrations(weeklyRes.data.data);
      setError(null);
    } catch (error) {
      console.error("Error fetching dashboard data:", error);
      setError("Failed to load dashboard data");
      if (error.response?.status === 401 || error.response?.status === 403) {
        navigate("/superadmin-login");
      }
    } finally {
      setLoading(false);
    }
  };

  // SuperAdmin authentication check
  useEffect(() => {
    const checkSuperAdminAuth = () => {
      const validation = validateSuperAdminToken();
      
      if (!validation.isValid) {
        console.log(`SuperAdmin authentication failed: ${validation.reason}`);
        navigate("/superadmin-login");
        return;
      }
      
      setIsAuthenticating(false);
      fetchDashboardData();
    };
    
    checkSuperAdminAuth();
  }, [navigate]);

  // Initialize user from localStorage if available
  useEffect(() => {
    const savedUser = localStorage.getItem("exim_user");
    if (savedUser && !user) {
      try {
        setUser(JSON.parse(savedUser));
      } catch (error) {
        console.error("Error parsing user data:", error);
        localStorage.removeItem("exim_user");
      }
    }
  }, [user, setUser]);

  // Fetch existing customers for user management modal
  const fetchExistingCustomers = async () => {
    try {
      const headers = getSuperAdminHeaders();
      if (!headers) return;
      
      const response = await axios.get(
        `${process.env.REACT_APP_API_STRING}/registered-customers`,
        headers
      );
      if (response.data.success) {
        setExistingCustomers(response.data.data);
      }
    } catch (error) {
      console.error("Error fetching existing customers:", error);
      setRegistrationError("Failed to load existing customers.");
    }
  };

  // Fetch KYC data for registration modal
  const fetchKycData = async () => {
    try {
      const headers = getSuperAdminHeaders();
      if (!headers) return;
      
      const response = await axios.get(
        `${process.env.REACT_APP_API_STRING}/customer-kyc-list`,
        headers
      );
      if (response.data.success) {
        setKycRecords(response.data.data);
      }
    } catch (error) {
      console.error("Error fetching KYC data:", error);
      setRegistrationError("Failed to load customer data. Please try manual registration.");
    }
  };

  // Show loading while authenticating
  if (isAuthenticating) {
    return (
      <Box sx={{ 
        display: "flex", 
        justifyContent: "center", 
        alignItems: "center", 
        minHeight: "100vh",
        flexDirection: "column",
        gap: 2
      }}>
        <CircularProgress size={60} />
        <Typography variant="h6" color="text.secondary">
          Verifying SuperAdmin Access...
        </Typography>
      </Box>
    );
  }

  // Handle tab changes
  const handleTabChange = (event, newValue) => {
    setActiveTab(newValue);
  };

  const handleUserActivityTabChange = (event, newValue) => {
    setUserActivityTab(newValue);
  };

  // Handle KYC selection
  const handleKycSelection = (event, value) => {
    setSelectedKyc(value);
    if (value) {
      setIeCodeNo(value.iec_no || "");
      setPanNumber(value.pan_no || "");
      setName(value.name_of_individual || "");
    } else {
      setIeCodeNo("");
      setPanNumber("");
      setName("");
    }
    setRegistrationError(null);
  };

  // Handle password change
  const handlePasswordChange = async () => {
    if (!selectedCustomer || !newPassword) {
      setRegistrationError("Please provide a new password");
      return;
    }

    if (newPassword.length < 6) {
      setRegistrationError("Password must be at least 6 characters long");
      return;
    }

    setUpdatingPassword(true);
    setRegistrationError(null);
    
    try {
      const headers = getSuperAdminHeaders();
      if (!headers) {
        setUpdatingPassword(false);
        return;
      }
      
      const response = await axios.put(
        `${process.env.REACT_APP_API_STRING}/customer/${selectedCustomer._id}/password`,
        { newPassword },
        headers
      );
      
      if (response.data.success) {
        setSuccessMessage(
          `Password updated successfully for ${selectedCustomer.name}!`
        );
        setGeneratedPassword(newPassword);
        setIeCodeNo(selectedCustomer.ie_code_no);
        
        const updatedCustomer = { 
          ...selectedCustomer, 
          initialPassword: newPassword, 
          password_changed: true 
        };
        
        setExistingCustomers(prev => 
          prev.map(customer => 
            customer._id === selectedCustomer._id 
              ? updatedCustomer
              : customer
          )
        );
        setSelectedCustomer(updatedCustomer);

        setTimeout(() => {
          setShowPasswordDialog(false);
          setSelectedCustomer(null);
          setNewPassword("");
        }, 500);
      }
    } catch (error) {
      console.error("Error updating password:", error);
      setRegistrationError(
        error.response?.data?.message || "Failed to update password"
      );
    } finally {
      setUpdatingPassword(false);
    }
  };  const openPasswordDialog = (customer) => {
    // Get the most current customer data from the list to ensure we have latest password info
    const currentCustomer = existingCustomers.find(c => c._id === customer._id) || customer;
    setSelectedCustomer(currentCustomer);
    setNewPassword("");
    setShowPasswordDialog(true);
    setRegistrationError(null);
  };

  // Copy to clipboard functionality
  const handleCopy = async (text, type) => {
    if (!text) return;
    
    // Check if modern clipboard API is available
    // Note: navigator.clipboard requires HTTPS or localhost
    if (window.navigator && 
        window.navigator.clipboard && 
        typeof window.navigator.clipboard.writeText === "function") {
      try {
        await window.navigator.clipboard.writeText(text);
        setCopySnackbar({ 
          open: true, 
          message: `${type} copied to clipboard!` 
        });
        return;
      } catch (err) {
        console.error('Modern clipboard API failed, falling back to legacy method:', err);
        // Fall through to the fallback method
      }
    }
    
    // Fallback approach for older browsers or non-HTTPS contexts
    let textArea;
    try {
      textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      const successful = document.execCommand("copy");
      if (successful) {
        setCopySnackbar({ 
          open: true, 
          message: `${type} copied to clipboard!` 
        });
      } else {
        throw new Error('Copy command failed');
      }
    } catch (err) {
      console.error("Fallback copy failed:", err);
      setCopySnackbar({ 
        open: true, 
        message: `Failed to copy ${type.toLowerCase()}` 
      });
    } finally {
      if (textArea && document.body.contains(textArea)) {
        document.body.removeChild(textArea);
      }
    }
  };
  const handleCopySnackbarClose = () => {
    setCopySnackbar({ ...copySnackbar, open: false });
  };
  // Generate password according to the rule: last 4 digits of IE + @ + first 4 chars of PAN
  const generatePasswordPreview = (ieCode, panNumber) => {
    if (!ieCode || !panNumber) return "";
    const iecPart = ieCode.slice(-4);
    const panPart = panNumber.slice(0, 4);
    return `${iecPart}@${panPart}`;
  };

  // SuperAdmin logout function
  const handleSuperAdminLogout = () => {
    // Clear SuperAdmin authentication data
    localStorage.removeItem("superadmin_token");
    localStorage.removeItem("superadmin_user");
    
    // Redirect to SuperAdmin login
    navigate("/superadmin-login");
  };

  const handleSubmit = async (event) => {
    event.preventDefault();
    setRegistrationError(null);
    setSuccessMessage(null);
    setIsSubmitting(true);

    // Basic validation
    if (!ie_code_no || !pan_number) {
      setRegistrationError("Please provide both IE Code and PAN Number");
      setIsSubmitting(false);
      return;
    }
    
    try {
      const headers = getSuperAdminHeaders();
      if (!headers) {
        // Token validation failed and user was redirected
        setIsSubmitting(false);
        return;
      }
      
      const res = await axios.post(
        `${process.env.REACT_APP_API_STRING}/register`,
        { 
          ie_code_no: ie_code_no.toUpperCase(), 
          pan_number: pan_number.toUpperCase(), 
          name: name.trim() || undefined 
        },
        headers
      );

      if (res.status === 201) {
        const { customer } = res.data;
          setSuccessMessage(
          `Registration successful! Your account has been created for ${customer.name}.`
        );
        setGeneratedPassword(customer.initialPassword);

        // Reset form fields
        setSelectedKyc(null);
        setIeCodeNo("");
        setPanNumber("");
        setName("");

        // Auto-redirect to login after 5 seconds
        setTimeout(() => {
          navigate("/login");
        }, 5000);
      }    } catch (error) {
      if (error.response) {
        switch (error.response.status) {
          case 400:
            setRegistrationError(error.response.data.message);
            break;
          case 401:
          case 403:
            setRegistrationError("SuperAdmin authentication expired. Please login again.");
            navigate("/superadmin-login");
            break;
          case 404:
            setRegistrationError("No records found with the provided IE Code or PAN Number. Please verify your details.");
            break;
          case 500:
            setRegistrationError("Server error. Please try again later.");
            break;
          default:
            setRegistrationError("An unexpected error occurred");
        }
      } else {
        setRegistrationError("Network error. Please check your connection.");
      }
    } finally {
      setIsSubmitting(false);
    }
  };  // Chart color schemes
  const pieChartColors = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042'];
  
  // Format data for charts
  const formatKycData = () => {
    if (!dashboardData) return [];
    return [
      { name: 'Completed', value: dashboardData.kycCompleted, color: '#4caf50' },
      { name: 'Pending', value: dashboardData.kycPending, color: '#ff9800' },
      { name: 'Rejected', value: dashboardData.kycRejected, color: '#f44336' }
    ];
  };

  const handleLogout = () => {
    localStorage.removeItem("superadmin_token");
    localStorage.removeItem("superadmin_user");
    navigate("/superadmin-login");
  };

  const renderOverviewCards = () => (
    <Grid container spacing={3} sx={{ mb: 4 }}>
      <Grid item xs={12} sm={6} lg={3}>
        <Card sx={{ 
          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
          color: 'white',
          height: '140px',
          display: 'flex',
          alignItems: 'center'
        }}>
          <CardContent sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
            <Group sx={{ fontSize: 40, mr: 2, opacity: 0.8 }} />
            <Box>
              <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                {loading ? '...' : dashboardData?.totalUsers || 0}
              </Typography>
              <Typography variant="body2" sx={{ opacity: 0.9 }}>
                Total Users
              </Typography>
            </Box>
          </CardContent>
        </Card>
      </Grid>
      
      <Grid item xs={12} sm={6} lg={3}>
        <Card sx={{ 
          background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
          color: 'white',
          height: '140px',
          display: 'flex',
          alignItems: 'center'
        }}>
          <CardContent sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
            <CheckCircle sx={{ fontSize: 40, mr: 2, opacity: 0.8 }} />
            <Box>
              <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                {loading ? '...' : dashboardData?.activeUsers || 0}
              </Typography>
              <Typography variant="body2" sx={{ opacity: 0.9 }}>
                Active Users
              </Typography>
            </Box>
          </CardContent>
        </Card>
      </Grid>
      
      <Grid item xs={12} sm={6} lg={3}>
        <Card sx={{ 
          background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
          color: 'white',
          height: '140px',
          display: 'flex',
          alignItems: 'center'
        }}>
          <CardContent sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
            <Security sx={{ fontSize: 40, mr: 2, opacity: 0.8 }} />
            <Box>
              <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                {loading ? '...' : dashboardData?.kycCompleted || 0}
              </Typography>
              <Typography variant="body2" sx={{ opacity: 0.9 }}>
                KYC Completed
              </Typography>
            </Box>
          </CardContent>
        </Card>
      </Grid>
      
      <Grid item xs={12} sm={6} lg={3}>
        <Card sx={{ 
          background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
          color: 'white',
          height: '140px',
          display: 'flex',
          alignItems: 'center'
        }}>
          <CardContent sx={{ display: 'flex', alignItems: 'center', width: '100%' }}>
            <TrendingUp sx={{ fontSize: 40, mr: 2, opacity: 0.8 }} />
            <Box>
              <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                {loading ? '...' : weeklyRegistrations?.reduce((sum, week) => sum + week.count, 0) || 0}
              </Typography>
              <Typography variant="body2" sx={{ opacity: 0.9 }}>
                Total Registrations
              </Typography>
            </Box>
          </CardContent>
        </Card>
      </Grid>
    </Grid>
  );

  const renderUserActivitySection = () => (
    <Card sx={{ mb: 3 }}>
      <CardContent>
        <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
          <PeopleAlt sx={{ mr: 2, color: 'primary.main' }} />
          <Typography variant="h6" sx={{ fontWeight: 600 }}>
            User Activity Overview
          </Typography>
        </Box>
        
        <Tabs value={userActivityTab} onChange={handleUserActivityTabChange} sx={{ mb: 2 }}>
          <Tab label="Active Users" />
          <Tab label="Inactive Users" />
        </Tabs>
        
        <TableContainer>
          <Table size="small">
            <TableHead>
              <TableRow>
                <TableCell>Customer Name</TableCell>
                <TableCell>IE Code</TableCell>
                <TableCell>Last Login</TableCell>
                <TableCell>Status</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={4} align="center">
                    <CircularProgress size={24} />
                  </TableCell>
                </TableRow>
              ) : userActivity.length > 0 ? (
                userActivity.slice(0, 5).map((user, index) => (
                  <TableRow key={index}>
                    <TableCell>{user.name}</TableCell>
                    <TableCell>{user.ie_code_no}</TableCell>
                    <TableCell>
                      {user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}
                    </TableCell>
                    <TableCell>
                      <Chip
                        label={userActivityTab === 0 ? 'Active' : 'Inactive'}
                        color={userActivityTab === 0 ? 'success' : 'default'}
                        size="small"
                      />
                    </TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell colSpan={4} align="center">
                    No data available
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </TableContainer>
      </CardContent>
    </Card>
  );

  const renderModuleAssignments = () => (
    <Card sx={{ mb: 3 }}>
      <CardContent>
        <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
          <Assignment sx={{ mr: 2, color: 'primary.main' }} />
          <Typography variant="h6" sx={{ fontWeight: 600 }}>
            Module Assignments
          </Typography>
        </Box>
        
        <TableContainer>
          <Table size="small">
            <TableHead>
              <TableRow>
                <TableCell>Customer</TableCell>
                <TableCell>Importer Module</TableCell>
                <TableCell>Customer Module</TableCell>
                <TableCell>Total Assignments</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={4} align="center">
                    <CircularProgress size={24} />
                  </TableCell>
                </TableRow>
              ) : moduleAssignments.length > 0 ? (
                moduleAssignments.slice(0, 5).map((assignment, index) => (
                  <TableRow key={index}>
                    <TableCell>{assignment.customerName}</TableCell>
                    <TableCell>
                      <Chip
                        label={assignment.importerCount}
                        color="primary"
                        size="small"
                        variant="outlined"
                      />
                    </TableCell>
                    <TableCell>
                      <Chip
                        label={assignment.customerCount}
                        color="secondary"
                        size="small"
                        variant="outlined"
                      />
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" sx={{ fontWeight: 600 }}>
                        {assignment.totalAssignments}
                      </Typography>
                    </TableCell>
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell colSpan={4} align="center">
                    No assignments found
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </TableContainer>
      </CardContent>
    </Card>
  );

  const renderAnalyticsCharts = () => (
    <Grid container spacing={3} sx={{ mb: 3 }}>
      <Grid item xs={12} lg={8}>
        <Card>
          <CardContent>
            <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
              <Timeline sx={{ mr: 2, color: 'primary.main' }} />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                Weekly Registrations
              </Typography>
            </Box>
            <Box sx={{ height: 300 }}>
              {weeklyRegistrations.length > 0 ? (
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={weeklyRegistrations}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis 
                      dataKey="week" 
                      tick={{ fontSize: 12 }}
                    />
                    <YAxis tick={{ fontSize: 12 }} />
                    <ChartTooltip />
                    <Line 
                      type="monotone" 
                      dataKey="count" 
                      stroke="#8884d8" 
                      strokeWidth={2}
                      dot={{ fill: '#8884d8', strokeWidth: 2, r: 4 }}
                    />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%' }}>
                  <Typography color="text.secondary">No registration data available</Typography>
                </Box>
              )}
            </Box>
          </CardContent>
        </Card>
      </Grid>
      
      <Grid item xs={12} lg={4}>
        <Card>
          <CardContent>
            <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
              <BarChart sx={{ mr: 2, color: 'primary.main' }} />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                KYC Status Breakdown
              </Typography>
            </Box>
            <Box sx={{ height: 300 }}>
              {dashboardData && (dashboardData.kycCompleted + dashboardData.kycPending + dashboardData.kycRejected > 0) ? (
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={formatKycData()}
                      cx="50%"
                      cy="50%"
                      outerRadius={80}
                      fill="#8884d8"
                      dataKey="value"
                      label={({ name, value }) => `${name}: ${value}`}
                    >
                      {formatKycData().map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <ChartTooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%' }}>
                  <Typography color="text.secondary">No KYC data available</Typography>
                </Box>
              )}
            </Box>
          </CardContent>
        </Card>
      </Grid>
    </Grid>
  );

  return (
    <Box sx={{ display: "flex", minHeight: "100vh", bgcolor: "#f8fafc" }}>
      {/* Main Content Area */}
      <Box 
        component="main" 
        sx={{ 
          flexGrow: 1, 
          p: { xs: 2, sm: 3, md: 4 },
          minHeight: "100vh",
          display: "flex",
          flexDirection: "column"
        }}
      >
        {/* Header Section */}
        <Box sx={{ 
          display: "flex", 
          flexDirection: { xs: "column", sm: "row" },
          justifyContent: "space-between", 
          alignItems: { xs: "flex-start", sm: "center" },
          mb: 4,
          gap: 2
        }}>
          <Box>
            <Typography 
              variant="h4" 
              component="h1" 
              sx={{ 
                fontWeight: 700,
                color: "text.primary",
                fontSize: { xs: "1.5rem", sm: "2rem", md: "2.5rem" },
                mb: 0.5,
                display: 'flex',
                alignItems: 'center'
              }}
            >
              <Dashboard sx={{ mr: 2, fontSize: 'inherit' }} />
              SuperAdmin Dashboard
            </Typography>
            <Typography 
              variant="body1" 
              color="text.secondary"
              sx={{ fontSize: { xs: "0.9rem", sm: "1rem" } }}
            >
              Comprehensive system overview and management controls
            </Typography>
          </Box>
          
          {/* Action Buttons */}
          <Box sx={{ 
            display: "flex", 
            flexDirection: { xs: "column", sm: "row" },
            gap: 2,
            width: { xs: "100%", sm: "auto" }
          }}>
            <Button
              variant="contained"
              onClick={() => setShowRegistrationModal(true)}
              startIcon={<PersonAdd />}
              sx={{ 
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                boxShadow: 2,
                '&:hover': { boxShadow: 4 }
              }}
            >
              Register User
            </Button>
            <Button
              variant="outlined"
              onClick={() => setShowUserManagementModal(true)}
              startIcon={<Settings />}
            >
              Manage Users
            </Button>
            <Button
              variant="outlined"
              color="error"
              onClick={handleLogout}
              startIcon={<Logout />}
            >
              Logout
            </Button>
          </Box>
        </Box>

        {/* Loading Indicator */}
        {loading && (
          <LinearProgress sx={{ mb: 3, borderRadius: 1, height: 4 }} />
        )}

        {/* Error Message */}
        {error && (
          <Alert severity="error" sx={{ mb: 3 }}>
            {error}
          </Alert>
        )}

        {/* Overview Cards */}
        {renderOverviewCards()}

        {/* Main Content Tabs */}
        <Card sx={{ flexGrow: 1 }}>
          <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
            <Tabs value={activeTab} onChange={handleTabChange} sx={{ px: 2 }}>
              <Tab 
                icon={<Analytics />} 
                iconPosition="start" 
                label="Analytics Overview" 
                sx={{ textTransform: 'none', minHeight: 64 }}
              />
              <Tab 
                icon={<PeopleAlt />} 
                iconPosition="start" 
                label="User Activity" 
                sx={{ textTransform: 'none', minHeight: 64 }}
              />
              <Tab 
                icon={<Assignment />} 
                iconPosition="start" 
                label="Module Assignments" 
                sx={{ textTransform: 'none', minHeight: 64 }}
              />
            </Tabs>
          </Box>
          
          <Box sx={{ p: 3 }}>
            {activeTab === 0 && (
              <Box>
                <Typography variant="h6" sx={{ mb: 3, fontWeight: 600 }}>
                  System Analytics
                </Typography>
                {renderAnalyticsCharts()}
              </Box>
            )}
            
            {activeTab === 1 && (
              <Box>
                <Typography variant="h6" sx={{ mb: 3, fontWeight: 600 }}>
                  User Activity Management
                </Typography>
                {renderUserActivitySection()}
              </Box>
            )}
            
            {activeTab === 2 && (
              <Box>
                <Typography variant="h6" sx={{ mb: 3, fontWeight: 600 }}>
                  Module Assignment Tracking
                </Typography>
                {renderModuleAssignments()}
              </Box>
            )}
          </Box>
        </Card>

        {/* Footer */}
        <Box sx={{ mt: 4, pt: 3, borderTop: 1, borderColor: 'divider', textAlign: 'center' }}>
          <Typography variant="body2" sx={{ color: "text.primary", fontWeight: 600, mb: 1 }}>
            Version: {process.env.REACT_APP_VERSION}
          </Typography>
          <Box sx={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 1 }}>
            <img
              src={require("../assets/images/alluvium-logo.webp")}
              width={30}
              alt="Alluvium Logo"
            />
            <Typography variant="body2" color="text.secondary">
              Powered By:&nbsp;
              <Link
                to="https://www.alluvium.in/"
                target="_blank"
                rel="noreferrer"
                style={{ textDecoration: "none", color: "inherit", fontWeight: 500 }}
              >
                AIVision | EXIM
              </Link>
            </Typography>
          </Box>
        </Box>
      </Box>
      
                                </Typography>
                              </CardContent>
                            </Card>
                          </Grid>
                        </Grid>
                      </Box>
                    </Fade>
                  )}

                  {/* Error and Success Messages */}
                  {registrationError && (
                    <Slide direction="down" in={!!registrationError}>
                      <Alert 
                        severity="error" 
                        sx={{ 
                          mb: 3,
                          borderRadius: 2,
                          "& .MuiAlert-icon": { fontSize: "1.2rem" }
                        }}
                        onClose={() => setRegistrationError(null)}
                      >
                        {registrationError}
                      </Alert>
                    </Slide>
                  )}

                  {successMessage && (
                    <Slide direction="down" in={!!successMessage}>
                      <Alert 
                        severity="success" 
                        sx={{ 
                          mb: 3,
                          borderRadius: 2,
                          "& .MuiAlert-icon": { fontSize: "1.2rem" }
                        }}
                      >
                        {successMessage}
                        {generatedPassword && (
                          <Box sx={{ 
                            mt: 2, 
                            p: 2, 
                            bgcolor: "success.50", 
                            borderRadius: 2, 
                            border: "1px solid", 
                            borderColor: "success.200" 
                          }}>
                            <Typography variant="body2" fontWeight="bold" color="success.dark" sx={{ mb: 1 }}>
                              ðŸŽ‰ Account Created Successfully!
                            </Typography>
                            <Box sx={{ 
                              bgcolor: "white", 
                              p: 2, 
                              borderRadius: 2, 
                              border: "2px solid", 
                              borderColor: "success.300" 
                            }}>
                              <Typography variant="body2" fontWeight="bold" color="text.primary" sx={{ mb: 1 }}>
                                Login Credentials:
                              </Typography>
                              <Box sx={{ display: "flex", alignItems: "center", mb: 1, flexWrap: "wrap", gap: 1 }}>
                                <Typography variant="body2">
                                  <strong>Username:</strong> {ie_code_no}
                                </Typography>
                                <Tooltip title="Copy Username">
                                  <IconButton 
                                    size="small" 
                                    onClick={() => handleCopy(ie_code_no, "Username")}
                                    sx={{ color: "primary.main", p: 0.5 }}
                                  >
                                    <ContentCopy sx={{ fontSize: "1rem" }} />
                                  </IconButton>
                                </Tooltip>
                              </Box>
                              <Box sx={{ display: "flex", alignItems: "center", flexWrap: "wrap", gap: 1 }}>
                                <Typography variant="body2">
                                  <strong>Password:</strong> 
                                  <Chip 
                                    label={generatedPassword}
                                    sx={{ 
                                      ml: 1,
                                      fontFamily: "monospace",
                                      fontWeight: "bold",
                                      bgcolor: "primary.main",
                                      color: "white"
                                    }}
                                  />
                                </Typography>
                                <Tooltip title="Copy Password">
                                  <IconButton 
                                    size="small" 
                                    onClick={() => handleCopy(generatedPassword, "Password")}
                                    sx={{ color: "primary.main", p: 0.5 }}
                                  >
                                    <ContentCopy sx={{ fontSize: "1rem" }} />
                                  </IconButton>
                                </Tooltip>
                              </Box>
                            </Box>
                            <Typography variant="caption" color="success.600" sx={{ mt: 1, display: "block" }}>
                              ðŸ’¡ Please save these credentials securely. You'll be redirected to login in 5 seconds.
                            </Typography>
                          </Box>
                        )}
                      </Alert>
                    </Slide>
                  )}{/* Registration Form - Only show in register mode */}
                  {viewMode === "register" ? (
                    <form onSubmit={handleSubmit}>
                      {registrationMode === "dropdown" ? (
                        // Dropdown Mode
                        <Box sx={{ mb: { xs: 2, sm: 3 } }}>
                          <Autocomplete
                            fullWidth
                            loading={loading}
                            options={kycRecords}
                            value={selectedKyc}
                            onChange={handleKycSelection}
                            getOptionLabel={(option) => 
                              `${option.name_of_individual} (IE: ${option.iec_no})`
                            }
                            renderOption={(props, option) => (
                              <Box component="li" {...props}>
                                <Box sx={{ flexGrow: 1 }}>
                                  <Typography variant="body1" fontWeight={500} sx={{ fontSize: { xs: "0.85rem", sm: "1rem" } }}>
                                    {option.name_of_individual}
                                  </Typography>
                                  <Typography variant="caption" color="text.secondary" sx={{ fontSize: { xs: "0.7rem", sm: "0.75rem" } }}>
                                    IE: {option.iec_no} | PAN: {option.pan_no}
                                  </Typography>
                                  {option.status && (
                                    <Chip 
                                      label={option.status} 
                                      size="small" 
                                      color="primary" 
                                      variant="outlined"
                                      sx={{ ml: 1, fontSize: { xs: "0.6rem", sm: "0.7rem" } }}
                                    />
                                  )}
                                </Box>
                              </Box>
                            )}
                            renderInput={(params) => (
                              <TextField
                                {...params}
                                label="Select Customer from KYC Records"
                                placeholder="Search by name or IE code..."
                                helperText="Choose from existing KYC verified customers"
                                size="small"
                                sx={{
                                  "& .MuiInputBase-input": { 
                                    fontSize: { xs: "0.8rem", sm: "0.9rem" } 
                                  },
                                  "& .MuiFormHelperText-root": {
                                    fontSize: { xs: "0.7rem", sm: "0.75rem" }
                                  }
                                }}
                                InputProps={{
                                  ...params.InputProps,
                                  endAdornment: (
                                    <>
                                      {loading ? <CircularProgress color="inherit" size={20} /> : null}
                                      {params.InputProps.endAdornment}
                                    </>
                                  ),
                                }}
                              />
                            )}
                            noOptionsText={loading ? "Loading customers..." : "No customers found"}
                          />
                        </Box>
                      ) : null}

                      {/* Form Fields */}
                      <Grid container spacing={{ xs: 1.5, sm: 2 }}>
                        <Grid item xs={12} sm={6}>
                          <TextField
                            fullWidth
                            label="IE Code Number"
                            value={ie_code_no}
                            onChange={(e) => setIeCodeNo(e.target.value.toUpperCase())}
                            helperText="Import Export Code"
                            required
                            size="small"
                            disabled={registrationMode === "dropdown" && selectedKyc}
                            sx={{ 
                              "& .MuiInputBase-input": { 
                                fontSize: { xs: "0.8rem", sm: "0.9rem" } 
                              },
                              "& .MuiFormHelperText-root": {
                                fontSize: { xs: "0.7rem", sm: "0.75rem" }
                              }
                            }}
                          />
                        </Grid>
                        <Grid item xs={12} sm={6}>
                          <TextField
                            fullWidth
                            label="PAN Number"
                            value={pan_number}
                            onChange={(e) => setPanNumber(e.target.value.toUpperCase())}
                            helperText="Permanent Account Number"
                            required
                            size="small"
                            disabled={registrationMode === "dropdown" && selectedKyc}
                            sx={{ 
                              "& .MuiInputBase-input": { 
                                fontSize: { xs: "0.8rem", sm: "0.9rem" } 
                              },
                              "& .MuiFormHelperText-root": {
                                fontSize: { xs: "0.7rem", sm: "0.75rem" }
                              }
                            }}
                          />
                        </Grid>
                        <Grid item xs={12}>
                          <TextField
                            fullWidth
                            label="Company/Individual Name (Optional)"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            helperText="Leave blank to use registered name"
                            size="small"
                            disabled={registrationMode === "dropdown" && selectedKyc}
                            sx={{ 
                              "& .MuiInputBase-input": { 
                                fontSize: { xs: "0.8rem", sm: "0.9rem" } 
                              },
                              "& .MuiFormHelperText-root": {
                                fontSize: { xs: "0.7rem", sm: "0.75rem" }
                              }
                            }}
                          />                        </Grid>
                      </Grid>

                      {/* Password Preview - Show when both IE code and PAN are entered */}
                      {ie_code_no && pan_number && (
                        <Box sx={{ 
                          mt: { xs: 2, sm: 3 }, 
                          p: 2, 
                          bgcolor: "info.50", 
                          borderRadius: 1, 
                          border: "1px solid", 
                          borderColor: "info.200" 
                        }}>
                          <Typography variant="body2" fontWeight="bold" color="info.dark" sx={{ fontSize: { xs: "0.8rem", sm: "0.875rem" }, mb: 1 }}>
                            ðŸ“‹ Generated Password Preview:
                          </Typography>
                          <Box sx={{ display: "flex", alignItems: "center", gap: 1, flexWrap: "wrap" }}>
                            <Typography variant="body2" sx={{ fontSize: { xs: "0.8rem", sm: "0.875rem" } }}>
                              Password: 
                              <span style={{ 
                                fontFamily: "monospace", 
                                backgroundColor: "#1976d2", 
                                color: "white",
                                padding: "4px 8px", 
                                borderRadius: "4px", 
                                marginLeft: "8px",
                                fontSize: "1rem",
                                fontWeight: "bold"
                              }}>
                                {generatePasswordPreview(ie_code_no, pan_number)}
                              </span>
                            </Typography>
                            <Tooltip title="Copy Generated Password">
                              <IconButton 
                                size="small" 
                                onClick={() => handleCopy(generatePasswordPreview(ie_code_no, pan_number), "Generated Password")}
                                sx={{ color: "primary.main", p: 0.5 }}
                              >
                                <ContentCopy sx={{ fontSize: { xs: "0.8rem", sm: "1rem" } }} />
                              </IconButton>
                            </Tooltip>
                          </Box>
                          <Typography variant="caption" color="info.600" sx={{ fontSize: { xs: "0.7rem", sm: "0.75rem" }, mt: 1, display: "block" }}>
                            ðŸ’¡ This password will be automatically generated based on your IE Code (last 4 digits) + @ + PAN Number (first 4 characters)
                          </Typography>
                        </Box>
                      )}

                      <Button
                        type="submit"
                        fullWidth
                        variant="contained"
                        color="primary"
                        disabled={isSubmitting || (registrationMode === "dropdown" && !selectedKyc)}
                        sx={{ 
                          mt: { xs: 2, sm: 3 }, 
                          mb: 2, 
                          py: { xs: 1, sm: 1.2, md: 1.5 },
                          fontSize: { xs: "0.8rem", sm: "0.9rem", md: "1rem" }
                        }}
                      >
                        {isSubmitting ? "Creating Account..." : "Register"}
                      </Button>
                    </form>                  ) : (
                    // Customer Management View
                    <Box sx={{ mt: 2 }}>
                      {loading ? (
                        <Box sx={{ display: "flex", justifyContent: "center", py: 3 }}>
                          <CircularProgress />
                        </Box>
                      ) : existingCustomers.length === 0 ? (
                        <Typography variant="body1" textAlign="center" color="text.secondary">
                          No registered customers found.
                        </Typography>
                      ) : (
                        <>
                          {/* Password Visibility Toggle */}
                          <Box sx={{ 
                            display: "flex", 
                            justifyContent: "space-between", 
                            alignItems: "center", 
                            mb: 2,
                            p: 2,
                            bgcolor: "grey.50",
                            borderRadius: 2,
                            border: "1px solid",
                            borderColor: "grey.200"
                          }}>
                            <Typography variant="h6" sx={{ fontWeight: 600 }}>
                              Customer Management ({existingCustomers.length})
                            </Typography>
                            <FormControlLabel
                              control={
                                <Switch
                                  checked={hidePasswords}
                                  onChange={(e) => setHidePasswords(e.target.checked)}
                                  color="primary"
                                />
                              }
                              label={
                                <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                                  {hidePasswords ? <VisibilityOff /> : <Visibility />}
                                  <Typography variant="body2">
                                    {hidePasswords ? "Show Passwords" : "Hide Passwords"}
                                  </Typography>
                                </Box>
                              }
                            />
                          </Box>
                          
                          <TableContainer component={Paper} elevation={1}>
                            <Table size="small">
                              <TableHead>
                                <TableRow>
                                  <TableCell sx={{ fontWeight: "bold", fontSize: { xs: "0.7rem", sm: "0.875rem" } }}>Name</TableCell>
                                  <TableCell sx={{ fontWeight: "bold", fontSize: { xs: "0.7rem", sm: "0.875rem" } }}>IE Code</TableCell>
                                  <TableCell sx={{ fontWeight: "bold", fontSize: { xs: "0.7rem", sm: "0.875rem" } }}>PAN</TableCell>
                                  <TableCell sx={{ fontWeight: "bold", fontSize: { xs: "0.7rem", sm: "0.875rem" } }}>Password</TableCell>
                                  <TableCell sx={{ fontWeight: "bold", fontSize: { xs: "0.7rem", sm: "0.875rem" } }}>Actions</TableCell>
                                </TableRow>
                              </TableHead>
                              <TableBody>
                                {existingCustomers.map((customer) => (
                                  <TableRow key={customer._id}>
                                    <TableCell sx={{ fontSize: { xs: "0.7rem", sm: "0.8rem" } }}>
                                      {customer.name}
                                    </TableCell>
                                    <TableCell sx={{ fontSize: { xs: "0.7rem", sm: "0.8rem" } }}>
                                      <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                                        <Typography variant="body2" sx={{ 
                                          fontFamily: "monospace",
                                          fontSize: { xs: "0.8rem", sm: "0.9rem" },
                                          fontWeight: "bold"
                                        }}>
                                          {customer.ie_code_no}
                                        </Typography>
                                        <Tooltip title="Copy Username">
                                          <IconButton 
                                            size="small" 
                                            onClick={() => handleCopy(customer.ie_code_no, "Username")}
                                            sx={{ color: "primary.main", ml: 0.5 }}
                                          >
                                            <ContentCopy sx={{ fontSize: { xs: "0.8rem", sm: "1rem" } }} />
                                          </IconButton>
                                        </Tooltip>
                                      </Box>
                                    </TableCell>
                                    <TableCell sx={{ fontSize: { xs: "0.7rem", sm: "0.8rem" } }}>
                                      {customer.pan_number}
                                    </TableCell>
                                    <TableCell sx={{ fontSize: { xs: "0.7rem", sm: "0.8rem" } }}>
                                      <Box sx={{ display: "flex", flexDirection: "column", gap: 0.5 }}>
                                        <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                                          <Typography variant="body2" sx={{ 
                                            fontFamily: "monospace",
                                            fontSize: { xs: "0.8rem", sm: "0.9rem" },
                                            backgroundColor: customer.password_changed ? "warning.50" : "primary.50",
                                            color: customer.password_changed ? "warning.800" : "primary.800",
                                            px: 1.5,
                                            py: 0.8,
                                            borderRadius: 1,
                                            border: "1px solid",
                                            borderColor: customer.password_changed ? "warning.200" : "primary.200",
                                            fontWeight: "bold"
                                          }}>
                                            {hidePasswords ? 
                                              "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : 
                                              (customer.password_changed && customer.initialPassword
                                                ? customer.initialPassword
                                                : (customer.ie_code_no && customer.pan_number 
                                                    ? generatePasswordPreview(customer.ie_code_no, customer.pan_number)
                                                    : (customer.initialPassword || "No Password")
                                                  )
                                              )
                                            }
                                          </Typography>
                                          {!hidePasswords && ((customer.password_changed && customer.initialPassword) || (customer.ie_code_no && customer.pan_number) || customer.initialPassword) && (
                                            <Tooltip title="Copy Password">
                                              <IconButton 
                                                size="small" 
                                                onClick={() => handleCopy(
                                                  customer.password_changed && customer.initialPassword
                                                    ? customer.initialPassword
                                                    : (customer.ie_code_no && customer.pan_number 
                                                        ? generatePasswordPreview(customer.ie_code_no, customer.pan_number)
                                                        : customer.initialPassword), 
                                                  "Password"
                                                )}
                                                sx={{ color: "primary.main" }}
                                              >
                                                <ContentCopy sx={{ fontSize: { xs: "0.8rem", sm: "1rem" } }} />
                                              </IconButton>
                                            </Tooltip>
                                          )}
                                        </Box>
                                        {customer.password_changed && (
                                          <Typography variant="caption" sx={{ 
                                            fontSize: { xs: "0.6rem", sm: "0.7rem" }, 
                                            color: "warning.700",
                                            fontStyle: "italic"
                                          }}>
                                            âš ï¸ Custom password (default changed)
                                          </Typography>
                                        )}
                                      </Box>
                                    </TableCell>
                                    <TableCell>
                                      <IconButton 
                                        size="small" 
                                        onClick={() => openPasswordDialog(customer)}
                                        sx={{ color: "primary.main" }}
                                      >
                                        <Edit sx={{ fontSize: { xs: "1rem", sm: "1.2rem" } }} />
                                      </IconButton>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          </TableContainer>
                        </>
                      )}
                    </Box>
                  )}

                  <Box sx={{ mt: 2, textAlign: "center" }}>
                    <Typography variant="body2" color="text.secondary" sx={{ fontSize: { xs: "0.8rem", sm: "0.875rem" } }}>
                      Registration is only available for customers with existing KYC records.
                    </Typography>
                  </Box>
                </Box>
              </CardContent>
            </Card>
            </Grid>

            {/* Right Column - Information Panel */}
            <Grid item xs={12} lg={4}>
              <Stack spacing={3}>
                {/* Quick Info Card */}
                <Card 
                  elevation={0} 
                  sx={{ 
                    border: "1px solid #e2e8f0",
                    borderRadius: 3,
                    background: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
                    color: "white"
                  }}
                >
                  <CardContent sx={{ p: 3 }}>
                    <Box sx={{ display: "flex", alignItems: "center", mb: 2 }}>
                      <Avatar sx={{ 
                        bgcolor: "rgba(255,255,255,0.2)", 
                        mr: 2,
                        width: 40,
                        height: 40
                      }}>
                        <Info />
                      </Avatar>
                      <Typography variant="h6" sx={{ fontWeight: 600 }}>
                        Quick Info
                      </Typography>
                    </Box>
                    <Typography variant="body2" sx={{ opacity: 0.9, lineHeight: 1.6 }}>
                      {viewMode === "register" 
                        ? "Register new customers using their KYC verified information or enter details manually."
                        : "Manage existing customer accounts and update their passwords as needed."
                      }
                    </Typography>
                  </CardContent>
                </Card>

                {/* Statistics Card */}
                <Card 
                  elevation={0} 
                  sx={{ 
                    border: "1px solid #e2e8f0",
                    borderRadius: 3
                  }}
                >
                  <CardContent sx={{ p: 3 }}>
                    <Typography variant="h6" sx={{ fontWeight: 600, mb: 2 }}>
                      System Statistics
                    </Typography>
                    <Stack spacing={2}>
                      <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                        <Box sx={{ display: "flex", alignItems: "center" }}>
                          <PeopleAlt sx={{ color: "primary.main", mr: 1 }} />
                          <Typography variant="body2">Total Customers</Typography>
                        </Box>
                        <Chip 
                          label={existingCustomers.length} 
                          color="primary" 
                          size="small"
                          sx={{ fontWeight: 600 }}
                        />
                      </Box>
                      <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                        <Box sx={{ display: "flex", alignItems: "center" }}>
                          <Assessment sx={{ color: "success.main", mr: 1 }} />
                          <Typography variant="body2">KYC Records</Typography>
                        </Box>
                        <Chip 
                          label={kycRecords.length} 
                          color="success" 
                          size="small"
                          sx={{ fontWeight: 600 }}
                        />
                      </Box>
                      <Box sx={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                        <Box sx={{ display: "flex", alignItems: "center" }}>
                          <Security sx={{ color: "warning.main", mr: 1 }} />
                          <Typography variant="body2">Custom Passwords</Typography>
                        </Box>
                        <Chip 
                          label={existingCustomers.filter(c => c.password_changed).length} 
                          color="warning" 
                          size="small"
                          sx={{ fontWeight: 600 }}
                        />
                      </Box>
                    </Stack>
                  </CardContent>
                </Card>

                {/* Help & Support Card */}
                <Card 
                  elevation={0} 
                  sx={{ 
                    border: "1px solid #e2e8f0",
                    borderRadius: 3,
                    background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                    color: "white"
                  }}
                >
                  <CardContent sx={{ p: 3 }}>
                    <Typography variant="h6" sx={{ fontWeight: 600, mb: 2 }}>
                      Need Help?
                    </Typography>
                    <Typography variant="body2" sx={{ opacity: 0.9, mb: 2, lineHeight: 1.6 }}>
                      If you encounter any issues during registration or customer management, please contact our support team.
                    </Typography>
                    <Button 
                      variant="outlined" 
                      size="small"
                      sx={{ 
                        borderColor: "rgba(255,255,255,0.5)",
                        color: "white",
                        "&:hover": {
                          borderColor: "white",
                          bgcolor: "rgba(255,255,255,0.1)"
                        }
                      }}
                    >
                      Contact Support
                    </Button>
                  </CardContent>
                </Card>
              </Stack>
            </Grid>
          </Grid>
        </Box>

        {/* Footer */}
        <Box 
          sx={{ 
            mt: 4,
            pt: 3,
            borderTop: "1px solid #e2e8f0",
            textAlign: "center"
          }}
        >
          <Typography variant="body2" sx={{ color: "text.primary", fontWeight: 600, mb: 1 }}>
            Version: {process.env.REACT_APP_VERSION}
          </Typography>
          <Box sx={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 1, mb: 1 }}>
            <img
              src={require("../assets/images/alluvium-logo.webp")}
              width={50}
              alt="Alluvium Logo"
            />
            <Typography variant="body2" color="text.secondary">
              Powered By:&nbsp;
              <Link
                to="https://www.alluvium.in/"
                target="_blank"
                rel="noreferrer"
                style={{ textDecoration: "none", color: "inherit", fontWeight: 500 }}
              >
                AIVision | EXIM
              </Link>
            </Typography>
          </Box>
        </Box>
      </Box>

      {/* Password Change Dialog */}
      <Dialog open={showPasswordDialog} onClose={() => setShowPasswordDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>
          Change Password for {selectedCustomer?.name}
        </DialogTitle>        <DialogContent>
          <Box sx={{ mb: 2, p: 2, bgcolor: "grey.50", borderRadius: 1, border: "1px solid", borderColor: "grey.200" }}>
            <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
              <strong>Customer Details:</strong>
            </Typography>
            <Typography variant="body2" sx={{ mb: 0.5 }}>
              <strong>IE Code:</strong> {selectedCustomer?.ie_code_no}
            </Typography>
            <Typography variant="body2" sx={{ mb: 0.5 }}>
              <strong>PAN:</strong> {selectedCustomer?.pan_number}
            </Typography>            <Typography variant="body2">
              <strong>Current Password:</strong> 
              <span style={{ 
                fontFamily: "monospace", 
                backgroundColor: selectedCustomer?.password_changed ? "#fff3e0" : "#e3f2fd", 
                padding: "4px 8px", 
                borderRadius: "4px", 
                marginLeft: "8px",
                fontWeight: "bold",
                color: selectedCustomer?.password_changed ? "#e65100" : "#1976d2"
              }}>
                {selectedCustomer?.password_changed && selectedCustomer?.initialPassword
                  ? selectedCustomer.initialPassword
                  : (selectedCustomer?.ie_code_no && selectedCustomer?.pan_number 
                      ? generatePasswordPreview(selectedCustomer.ie_code_no, selectedCustomer.pan_number)
                      : (selectedCustomer?.initialPassword || "No Password Set")
                    )
                }
              </span>
              {((selectedCustomer?.password_changed && selectedCustomer?.initialPassword) || (selectedCustomer?.ie_code_no && selectedCustomer?.pan_number)) && (
                <Tooltip title="Copy Current Password">
                  <IconButton 
                    size="small" 
                    onClick={() => handleCopy(
                      selectedCustomer?.password_changed && selectedCustomer?.initialPassword
                        ? selectedCustomer.initialPassword
                        : generatePasswordPreview(selectedCustomer.ie_code_no, selectedCustomer.pan_number), 
                      "Current Password"
                    )}
                    sx={{ color: "primary.main", ml: 1, p: 0.5 }}
                  >
                    <ContentCopy sx={{ fontSize: "0.8rem" }} />
                  </IconButton>
                </Tooltip>
              )}
            </Typography>
            {selectedCustomer?.password_changed && (
              <Typography variant="caption" sx={{ 
                fontSize: { xs: "0.7rem", sm: "0.75rem" }, 
                color: "warning.700",
                fontStyle: "italic",
                mt: 0.5,
                display: "block"
              }}>
                âš ï¸ This is a custom password (default password was changed)
              </Typography>
            )}
            {!selectedCustomer?.password_changed && selectedCustomer?.ie_code_no && selectedCustomer?.pan_number && (
              <Typography variant="caption" sx={{ 
                fontSize: { xs: "0.7rem", sm: "0.75rem" }, 
                color: "info.600",
                fontStyle: "italic",
                mt: 0.5,
                display: "block"
              }}>
                ðŸ’¡ This is the system-generated default password
              </Typography>
            )}
          </Box>
          <TextField
            fullWidth
            label="New Password"
            type={showPassword ? "text" : "password"}
            value={newPassword}
            onChange={(e) => setNewPassword(e.target.value)}
            helperText="Password must be at least 6 characters long"
            size="small"
            sx={{ mt: 1 }}
            InputProps={{
              endAdornment: (
                <InputAdornment position="end">
                  <IconButton
                    onClick={() => setShowPassword(!showPassword)}
                    edge="end"
                    size="small"
                  >
                    {showPassword ? <VisibilityOff /> : <Visibility />}
                  </IconButton>
                </InputAdornment>
              ),
            }}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setShowPasswordDialog(false)} disabled={updatingPassword}>
            Cancel
          </Button>
          <Button 
            onClick={handlePasswordChange} 
            variant="contained"
            disabled={updatingPassword || !newPassword}
          >
            {updatingPassword ? "Updating..." : "Update Password"}
          </Button>        </DialogActions>
      </Dialog>      {/* Copy Feedback Snackbar */}
      <Snackbar
        open={copySnackbar.open}
        autoHideDuration={2000}
        onClose={handleCopySnackbarClose}
        message={copySnackbar.message}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
      />
      </Box>
    </Box>
  );
}

export default RegisterPage;